AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Template CloudFormation per gestire componenti AWS

Parameters:
  ApiStageName:
    Type: String
    Default: "dev"
    Description: "Nome dello stage per l'API Gateway"
  StateTrigger:
    Type: String
    Default: "ENABLED"
    AllowedValues:
      - "ENABLED"
      - "DISABLED"
  BucketName:
    Type: String
    Default: "es12-application"
  InputFolderName:
    Type: String
    Default: "INPUT"
  DezippedFolderName:
    Type: String
    Default: "DEZIPPED"
  CsvFolderName:
    Type: String
    Default: "CSV"
  ZipFileExtension:
    Type: String
    Default: "zip"
  ExcelFileExtension:
    Type: String
    Default: "xlsx"
  CsvFileExtension:
    Type: String
    Default: "csv"

  DynamoTableName:
    Type: String
    Default: "es12-log"

  RDSDatabaseName:
    Type: String
    Default: "es12db"
    AllowedPattern: "[a-zA-Z0-9]+"
  RDSTableName:
    Type: String
    Default: "es12table"
  RDSInstanceClass:
    Type: String
    Default: "db.t3.micro"
    Description: "Classe di istanza RDS"
  RDSAllocatedStorage:
    Type: Number
    Default: 20
    Description: "Spazio di archiviazione allocato in GB"
  RDSEngine:
    Type: String
    Default: "aurora-mysql"
    AllowedValues:
      - "aurora-mysql"
      - "aurora-postgresql"
    Description: "Motore del database Aurora"
#  RDSEngineVersion:
#    Type: String
#    Default: "8.0.28"
#    Description: "Versione del motore del database"
  RDSMasterUsername:
    Type: String
    Default: "admin"
    Description: "Nome utente master per RDS"
  RDSMasterUserPassword:
    Type: String
    NoEcho: true
    Description: "Password per l'utente master RDS"
    Default: "superS3cret"
    MinLength: 8
    MaxLength: 41
    AllowedPattern: "[a-zA-Z0-9]+"
    ConstraintDescription: "deve contenere solo caratteri alfanumerici"
  VpcId:
    Type: AWS::EC2::VPC::Id
    Default: "YY"
    Description: "ID del VPC in cui creare il security group RDS"
    ConstraintDescription: must be the id of an existing VPC
  Subnet1:
    Type: AWS::EC2::Subnet::Id
    Description: "ID della prima subnet per RDS"
    ConstraintDescription: must be the id of an existing Subnet.
  Subnet2:
    Type: AWS::EC2::Subnet::Id
    Description: "ID della seconda subnet per RDS"
    ConstraintDescription: must be the id of an existing Subnet.

  LambdaRuntime:
    Type: String
    Default: "python3.11"
    Description: "Runtime per le funzioni Lambda"
  LambdaMemorySize:
    Type: Number
    Default: 128
    Description: "Memoria allocata per le funzioni Lambda (in MB)"
  LambdaTimeout:
    Type: Number
    Default: 30
    Description: "Timeout per le funzioni Lambda (in secondi)"
  SftpInputFolderName:
    Type: String
    Default: "TOSENDSFTP/"
    Description: "Cartella per l'invio via sftp"
  SftpUsername:
    Type: String
    Description: "Username per l'invio via sftp"
  SftpHost:
    Type: String
    Description: "Host per l'invio via sftp"
  SftpPort:
    Type: String
    Default: "22"
    Description: "Porta per l'invio via sftp"
  SftpPrivateKeyParam:
    Type: String
    Description: "Nome del parametro SSM contenente la chiave per l'invio via sftp"
  DynamoScanTableSuffix:
    Type: String
    Default: "-scan"
    Description: "Suffisso per la tabella DynamoDB usata dalla scansione S3"
  EnableAPI:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
    Description: "Abilita la creazione delle risorse API Gateway e relative Lambda/API."
  EnableEventBridge:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
    Description: "Abilita la creazione delle regole EventBridge."
  AuroraServerlessV2:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: "Abilita Aurora Serverless v2 se Aurora è selezionato come motore."
  TagEsempio12:
    Type: String
    Default: "esempio-12"
    Description: "Tag identificativo per tutte le risorse di esempio 12"

Conditions:
  IsAuroraMySQL: !Equals [!Ref RDSEngine, "aurora-mysql"]
  IsAuroraPostgres: !Equals [!Ref RDSEngine, "aurora-postgresql"]
  IsAurora: !Or [!Condition IsAuroraMySQL, !Condition IsAuroraPostgres]
  UseAuroraServerlessV2: !Equals [!Ref AuroraServerlessV2, "true"]
  EnableEventBridgeCondition: !Equals [!Ref EnableEventBridge, "true"]
  EnableAPICondition: !Equals [!Ref EnableAPI, "true"]

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT, POST, DELETE, HEAD]
            AllowedOrigins: ['*']
            ExposedHeaders: [ETag]
            MaxAge: 3000
      BucketPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: uno
            Effect: Allow
            Principal: '*'
            Action: '*'
            Resource: !Sub "arn:aws:s3:::${BucketName}/*"
          - Sid: due
            Effect: Allow
            Principal: '*'
            Action: '*'
            Resource: !Sub "arn:aws:s3:::${BucketName}"
      Tags:
        - Key: esempio-12
          Value: !Ref TagEsempio12

#  EventBridgeRule:
#    Type: AWS::Events::Rule
#    Properties:
#      Description: "EventBridge rule for triggering Lambda functions"
#      EventPattern:
#        source:
#          - "aws.s3"
#        detail-type:
#          - "Object Created"
#      State: !Ref StateTrigger
#      Targets:
#        - Arn: !GetAtt DecompressLambda.Arn
#          Id: "DecompressLambdaTarget"
#        - Arn: !GetAtt ConvertToCSVLambda.Arn
#          Id: "ConvertToCSVLambdaTarget"
#        - Arn: !GetAtt ProcessCSVLambda.Arn
#          Id: "ProcessCSVLambdaTarget"

  DecompressZipEventRule:
    Type: AWS::Events::Rule
    Condition: EnableEventBridgeCondition
    Properties:
      Description: "EventBridge rule to trigger DecompressLambda on ZIP file upload"
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - "Object Created"
        detail:
          bucket:
            name:
              - !Ref S3Bucket
          object:
            key:
              - prefix: !Ref InputFolderName
            key:
              - suffix: !Ref ZipFileExtension
      State: !Ref StateTrigger
      Targets:
        - Arn: !GetAtt DecompressLambda.Arn
          Id: "DecompressLambdaTarget"

  ConvertToCSVEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "EventBridge rule to trigger ConvertToCSVLambda on Excel file creation"
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - "Object Created"
        detail:
          bucket:
            name:
              - !Ref S3Bucket
          object:
            key:
              - prefix: !Ref DezippedFolderName
            key:
              - suffix: !Ref ExcelFileExtension
      State: !Ref StateTrigger
      Targets:
        - Arn: !GetAtt ConvertToCSVLambda.Arn
          Id: "ConvertToCSVLambdaTarget"

  ProcessCSVEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "EventBridge rule to trigger ProcessCSVLambda on CSV file creation"
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - "Object Created"
        detail:
          bucket:
            name:
              - !Ref S3Bucket
          object:
            key:
              - prefix: !Ref CsvFolderName
            key:
              - suffix: !Ref CsvFileExtension
      State: !Ref StateTrigger
      Targets:
        - Arn: !GetAtt ProcessCSVLambda.Arn
          Id: "ProcessCSVLambdaTarget"

  RDSCluster:
    Type: AWS::RDS::DBCluster
    Condition: IsAurora
    Properties:
      Engine: !Ref RDSEngine
      MasterUsername: !Ref RDSMasterUsername
      MasterUserPassword: !Ref RDSMasterUserPassword
      DBSubnetGroupName: !Ref RDSSubnetGroup
      VpcSecurityGroupIds:
        - !Ref RDSSecurityGroup
      DatabaseName: !Ref RDSDatabaseName
      BackupRetentionPeriod: 7
      DeletionProtection: true
      Port: !If [IsAuroraPostgres, 5432, 3306]
      EngineMode: !If [UseAuroraServerlessV2, "provisioned", "provisioned"]
      ScalingConfiguration:
        !If [UseAuroraServerlessV2, {MinCapacity: 0.5, MaxCapacity: 2, AutoPause: true, SecondsUntilAutoPause: 300}, !Ref "AWS::NoValue"]
      Tags:
        - Key: esempio-12
          Value: !Ref TagEsempio12

  RDSClusterInstance:
    Type: AWS::RDS::DBInstance
    Condition: IsAurora
    Properties:
      DBClusterIdentifier: !Ref RDSCluster
      DBInstanceClass: !Ref RDSInstanceClass
      Engine: !Ref RDSEngine
      PubliclyAccessible: false
      DBSubnetGroupName: !Ref RDSSubnetGroup
      Tags:
        - Key: esempio-12
          Value: !Ref TagEsempio12

# nota: se non si usa Aurora Serverless, si può usare RDSDatabase come risorsa principale con RDS MySql o RDS Postgres
#  RDSDatabase:
#    Type: AWS::RDS::DBInstance
#    Condition: IsRDSInstance
#    Properties:
#      DBName: !Ref RDSDatabaseName
#      DBInstanceIdentifier: !Sub "${AWS::StackName}-rds-instance"
#      AllocatedStorage: !Ref RDSAllocatedStorage
#      DBInstanceClass: !Ref RDSInstanceClass
#      Engine: !Ref RDSEngine
#      MasterUsername: !Ref RDSMasterUsername
#      MasterUserPassword: !Ref RDSMasterUserPassword
#      MultiAZ: false
#      PubliclyAccessible: false
#      StorageType: gp2
#      BackupRetentionPeriod: 7
#      DeleteAutomatedBackups: false
#      DeletionProtection: true
#      Port: !If [IsPostgres, 5432, 3306]
#      VPCSecurityGroups: 
#        - !Ref RDSSecurityGroup
#      DBSubnetGroupName: !Ref RDSSubnetGroup
#      Tags:
#        - Key: esempio-12
#          Value: !Ref TagEsempio12

  RDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Subnet group for RDS database"
      SubnetIds: 
        - !Ref Subnet1
        - !Ref Subnet2
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-RDSSubnetGroup"
        - Key: esempio-12
          Value: !Ref TagEsempio12

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for RDS database"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !If [IsPostgres, 5432, 3306]
          ToPort: !If [IsPostgres, 5432, 3306]
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-RDSSecurityGroup"
        - Key: esempio-12
          Value: !Ref TagEsempio12

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref DynamoTableName
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      Tags:
        - Key: esempio-12
          Value: !Ref TagEsempio12

  DynamoScanTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${DynamoTableName}${DynamoScanTableSuffix}"
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: nomeFile
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: nomeFile-index
          KeySchema:
            - AttributeName: nomeFile
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      Tags:
        - Key: esempio-12
          Value: !Ref TagEsempio12

  ApiGatewayCloudWatchRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - apigateway.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs'
  ApiGatewayAccountConfig:
    Type: 'AWS::ApiGateway::Account'
    Properties:
      CloudWatchRoleArn: !GetAtt ApiGatewayCloudWatchRole.Arn

  ApiGateway:
    Type: AWS::Serverless::Api
    Condition: EnableAPICondition
    DependsOn: 
      - ApiGatewayAccountConfig
      - LambdaExecutionRole
    Properties:
      StageName: !Ref ApiStageName
      Cors:
        AllowMethods: "'GET,POST,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          MetricsEnabled: true
          DataTraceEnabled: true
          LoggingLevel: INFO
      CacheClusterEnabled: false
      DefinitionBody:
        swagger: "2.0"
        info:
          version: "1.0"
          title: "ES12 API"
        paths:
          /read-rds-data:
            get:
              x-amazon-apigateway-integration:
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ReadRDSDataLambda.Arn}/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
          /read-dynamodb-data:
            get:
              x-amazon-apigateway-integration:
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ReadDynamoDBDataLambda.Arn}/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
          /list-excel-files:
            get:
              x-amazon-apigateway-integration:
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ListExcelFilesLambda.Arn}/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
          /download-excel-file:
            get:
              x-amazon-apigateway-integration:
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DownloadExcelFileLambda.Arn}/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
          /upload-zip:
            get:
              x-amazon-apigateway-integration:
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UploadZipLambda.Arn}/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
          /list-new-files:
            get:
              x-amazon-apigateway-integration:
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ListNewFilesLambda.Arn}/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
          /find-file:
            get:
              x-amazon-apigateway-integration:
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FindFileLambda.Arn}/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
      TracingEnabled: true
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: '{ "requestId":"$context.requestId", "ip": "$context.identity.sourceIp", "caller":"$context.identity.caller", "user":"$context.identity.user", "requestTime":"$context.requestTime", "httpMethod":"$context.httpMethod", "resourcePath":"$context.resourcePath", "status":"$context.status", "protocol":"$context.protocol", "responseLength":"$context.responseLength" }'

  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/apigateway/${AWS::StackName}-api-gateway"
      RetentionInDays: 30

  DecompressLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-decompress-lambda"
      Handler: decompress_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3Bucket
          DEZIPPED_FOLDER_NAME: !Ref DezippedFolderName
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  ConvertToCSVLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-convert-to-csv-lambda"
      Handler: convert_to_csv_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3Bucket
          CSV_FOLDER_NAME: !Ref CsvFolderName
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  ProcessCSVLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-process-csv-lambda"
      Handler: process_csv_lambda_mysql.handler #!If [IsPostgres, process_csv_lambda_postgres.handler, process_csv_lambda_mysql.handler] 
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3Bucket
          RDS_HOST: !GetAtt RDSCluster.Endpoint.Address
          RDS_PORT: !GetAtt RDSCluster.Endpoint.Port
          RDS_DATABASE_NAME: !Ref RDSDatabaseName
          RDS_TABLE_NAME: !Ref RDSTableName
          DYNAMO_TABLE_NAME: !Ref DynamoTableName
          RDS_ENGINE: !Ref RDSEngine
          RDS_SECRET_ARN: !Ref RDSSecret
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SubnetIds:
          - !Ref Subnet1
          - !Ref Subnet2
        SecurityGroupIds:
          - !Ref RDSSecurityGroup
      Tags:
        TagEsempio12: !Ref TagEsempio12

  ReadRDSDataLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-read-rds-data-lambda"
      Handler: read_rds_data_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          RDS_HOST: !GetAtt RDSCluster.Endpoint.Address
          RDS_PORT: !GetAtt RDSCluster.Endpoint.Port
          RDS_DATABASE_NAME: !Ref RDSDatabaseName
          RDS_TABLE_NAME: !Ref RDSTableName
          RDS_ENGINE: !Ref RDSEngine
          RDS_SECRET_ARN: !Ref RDSSecret
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SubnetIds:
          - !Ref Subnet1
          - !Ref Subnet2
        SecurityGroupIds:
          - !Ref RDSSecurityGroup
      Tags:
        TagEsempio12: !Ref TagEsempio12

  ReadDynamoDBDataLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-read-dynamodb-data-lambda"
      Handler: read_dynamodb_data_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          DYNAMODB_TABLE_NAME: !Ref DynamoTableName
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  ListExcelFilesLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-list-excel-files-lambda"
      Handler: list_excel_files_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3Bucket
          DEZIPPED_FOLDER_NAME: !Ref DezippedFolderName
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  DownloadExcelFileLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-download-excel-file-lambda"
      Handler: download_excel_file_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3Bucket
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  UploadZipLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-upload-zip-lambda"
      Handler: upload_zip_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3Bucket
          INPUT_FOLDER_NAME: !Ref InputFolderName
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12


  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - apigateway.amazonaws.com
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaExecutionPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                  - s3:PutObjectAcl
                Resource:
                  - !Sub "arn:aws:s3:::${S3Bucket}"
                  - !Sub "arn:aws:s3:::${S3Bucket}/*"
# versione RDS-MySQL
#              - Effect: Allow
#                Action:
#                  - rds-data:ExecuteStatement
#                  - rds-data:BatchExecuteStatement
#                Resource: !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${RDSDatabase}"
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: 
                  - !Sub "arn:aws:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${RDSClusterResourceId}/${AuroraDBUser}"
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: 
                  - !Ref RDSSecret
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: 
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoTableName}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoTableName}-scan"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: arn:aws:logs:*:*:*
                #Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
              - Effect: Allow
                Action: #https://stackoverflow.com/questions/41177965/the-provided-execution-role-does-not-have-permissions-to-call-describenetworkint
                  - 'ec2:DescribeNetworkInterfaces'
                  - 'ec2:CreateNetworkInterface'
                  - 'ec2:DeleteNetworkInterface'
                  - 'ec2:DescribeInstances'
                  - 'ec2:AttachNetworkInterface'
                Resource: '*'
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${SftpPrivateKeyParam}'
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref RDSSecret

  DecompressLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DecompressLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt DecompressZipEventRule.Arn

  ConvertToCSVLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ConvertToCSVLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ConvertToCSVEventRule.Arn

  ProcessCSVLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ProcessCSVLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ProcessCSVEventRule.Arn

  ReadRDSDataLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ReadRDSDataLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/GET/read-rds-data"

  ReadDynamoDBDataLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ReadDynamoDBDataLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/GET/read-dynamodb-data"

  ListExcelFilesLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ListExcelFilesLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/GET/list-excel-files"

  DownloadExcelFileLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DownloadExcelFileLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/GET/download-excel-file"

  UploadZipLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref UploadZipLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/GET/upload-zip"

  SendSftpRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "EventBridge rule to trigger SendSftpLambda on file upload"
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - "Object Created"
        detail:
          bucket:
            name:
              - !Ref S3Bucket
          object:
            key:
              - prefix: !Ref SftpInputFolderName
#            key:
#              - suffix: !Ref ZipFileExtension
      State: !Ref StateTrigger
      Targets:
        - Arn: !GetAtt SendSftpLambda.Arn
          Id: "SendSftpLambdaTarget"
  SendSftpLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-send-sftp"
      CodeUri: ./lambdaSftp
      Handler: sftpclient.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      Environment:
        Variables:
          USERNAME: !Ref SftpUsername
          HOST: !Ref SftpHost
          PORT: !Ref SftpPort
          PRIVATE_KEY_PARAM: !Ref SftpPrivateKeyParam
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12
  SendSftpLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SendSftpLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt SendSftpRule.Arn

  ScanS3AndUpdateDynamoLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-scan-s3-update-dynamo"
      Handler: scan_s3_update_dynamo_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: 300
      CodeUri: ./lambda
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3Bucket
          DYNAMO_TABLE_NAME: !Sub "${DynamoTableName}${DynamoScanTableSuffix}"
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  ScanS3AndUpdateDynamoSchedule:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedula la scansione S3 ogni giorno alle 01:00"
      ScheduleExpression: 'cron(0 1 * * ? *)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt ScanS3AndUpdateDynamoLambda.Arn
          Id: "ScanS3AndUpdateDynamoTarget"

  ScanS3AndUpdateDynamoLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ScanS3AndUpdateDynamoLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ScanS3AndUpdateDynamoSchedule.Arn

  FindFileLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-find-file-lambda"
      Handler: find_file_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          DYNAMO_TABLE_NAME: !Sub "${DynamoTableName}${DynamoScanTableSuffix}"
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  FindFileLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FindFileLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/GET/find-file"

  ListNewFilesLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-list-new-files-lambda"
      Handler: list_new_files_lambda.handler
      Runtime: !Ref LambdaRuntime
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      CodeUri: ./lambda
      Environment:
        Variables:
          DYNAMO_TABLE_NAME: !Sub "${DynamoTableName}${DynamoScanTableSuffix}"
      Role: !GetAtt LambdaExecutionRole.Arn
      Tags:
        TagEsempio12: !Ref TagEsempio12

  ListNewFilesLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ListNewFilesLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/GET/list-new-files"

  RDSSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AWS::StackName}-rds-secret"
      Description: "Credenziali RDS per Lambda"
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${RDSMasterUsername}"}'
        GenerateStringKey: "password"
        PasswordLength: 20
        ExcludeCharacters: '"@/\\'
      Tags:
        - Key: esempio-12
          Value: !Ref TagEsempio12

  ProcessCSVLambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ProcessCSVLambda-Errors"
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ProcessCSVLambda
      AlarmDescription: "Allarme: errori nella Lambda ProcessCSVLambda"
      TreatMissingData: notBreaching

  ReadRDSDataLambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ReadRDSDataLambda-Errors"
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ReadRDSDataLambda
      AlarmDescription: "Allarme: errori nella Lambda ReadRDSDataLambda"
      TreatMissingData: notBreaching

  ApiGateway5XXAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ApiGateway-5XX"
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref ApiGateway
      AlarmDescription: "Allarme: errori 5XX su API Gateway"
      TreatMissingData: notBreaching

Outputs:
  ApiGatewayUrl:
    Description: "URL dell'API Gateway"
    Value: !If [EnableAPICondition, !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${ApiStageName}", "DISABLED"]
  S3BucketName:
    Description: "Nome del bucket S3"
    Value: !Ref S3Bucket
  S3BucketArn:
    Description: "ARN del bucket S3"
    Value: !GetAtt S3Bucket.Arn
  RDSEndpoint:
    Description: "Endpoint del database Aurora"
    Value: !GetAtt RDSCluster.Endpoint.Address
  RDSPort:
    Description: "Porta del database Aurora"
    Value: !GetAtt RDSCluster.Endpoint.Port
  RDSClusterArn:
    Description: "ARN del cluster Aurora"
    Value: !GetAtt RDSCluster.Arn
  RDSDatabaseArn:
    Description: "ARN dell'istanza RDS (se non Aurora)"
    Value: !If [IsRDSInstance, !GetAtt RDSDatabase.Arn, "N/A"]
  RDSSecretArn:
    Description: "ARN del secret delle credenziali RDS"
    Value: !Ref RDSSecret
  DynamoTableName:
    Description: "Nome della tabella DynamoDB"
    Value: !Ref DynamoTableName
  DynamoTableArn:
    Description: "ARN della tabella DynamoDB"
    Value: !GetAtt DynamoDBTable.Arn
  DynamoScanTableName:
    Description: "Nome della tabella DynamoDB usata per la scansione S3"
    Value: !Sub "${DynamoTableName}${DynamoScanTableSuffix}"
  DynamoScanTableArn:
    Description: "ARN della tabella DynamoDB usata per la scansione S3"
    Value: !GetAtt DynamoScanTable.Arn
  ProcessCSVLambdaArn:
    Description: "ARN della Lambda di process csv"
    Value: !GetAtt ProcessCSVLambda.Arn
  ReadRDSDataLambdaArn:
    Description: "ARN della Lambda di lettura RDS"
    Value: !GetAtt ReadRDSDataLambda.Arn
  ScanS3AndUpdateDynamoLambdaArn:
    Description: "ARN della Lambda di scansione S3 e aggiornamento DynamoDB"
    Value: !GetAtt ScanS3AndUpdateDynamoLambda.Arn
  ListNewFilesLambdaArn:
    Description: "ARN della Lambda per elencare i file nuovi"
    Value: !GetAtt ListNewFilesLambda.Arn
  FindFileLambdaArn:
    Description: "ARN della Lambda per ricerca file per nome"
    Value: !GetAtt FindFileLambda.Arn